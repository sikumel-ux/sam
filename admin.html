<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MOYA Admin</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div class="app-container">
    <header class="header"><h1>MOYA</h1><p>Admin Dashboard</p></header>
    
    <main class="content">
      <section id="transaksi" class="page active">
        <div class="card">
          <h3><i class="fas fa-shopping-cart"></i> Penjualan</h3>
          <input type="date" id="t-tgl">
          <input type="text" id="t-nama" placeholder="Nama Pelanggan">
          <input type="tel" id="t-wa" placeholder="WhatsApp (08xx)">
          <input type="number" id="t-amt" placeholder="Nominal Rp" inputmode="numeric">
          <textarea id="t-desc" placeholder="Keterangan (Contoh: 2 Galon)"></textarea>
          <button onclick="simpanTransaksi()" id="btn-trx" class="btn-submit">SIMPAN & KIRIM WA</button>
        </div>
      </section>
      
      <section id="laporan" class="page">
        <div class="card">
          <h3><i class="fas fa-history"></i> Riwayat</h3>
          <div id="log-data"></div>
        </div>
      </section>
    </main>

    <nav>
      <button onclick="nav('transaksi', this)" class="nav-item active"><i class="fas fa-plus"></i><span>Input</span></button>
      <button onclick="nav('laporan', this)" class="nav-item"><i class="fas fa-list"></i><span>Laporan</span></button>
    </nav>
  </div>

  <script>
    const API_URL = "https://script.google.com/macros/s/AKfycbxsUJ_vgSx3m1sXCcHkbBN-gFPyt5EjO2IMTXbHQPeWOEcqoy544jAB5XPznrfh6018cw/exec";
    const GITHUB_URL = "https://moya.sekawan.my.id";

    document.getElementById('t-tgl').valueAsDate = new Date();

    function nav(id, el) {
      document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
      document.querySelectorAll('.nav-item').forEach(b => b.classList.remove('active'));
      document.getElementById(id).classList.add('active'); el.classList.add('active');
      if(id === 'laporan') muatLaporan();
    }

    async function simpanTransaksi() {
      const btn = document.getElementById('btn-trx');
      const data = {
        tgl: document.getElementById('t-tgl').value,
        nama: document.getElementById('t-nama').value,
        wa: document.getElementById('t-wa').value,
        amt: document.getElementById('t-amt').value,
        ket: document.getElementById('t-desc').value
      };

      if(!data.wa || !data.amt) return Swal.fire('Error', 'WA & Nominal wajib!', 'error');

      btn.disabled = true; btn.innerText = "PROSES...";
      const idTrx = "M" + Math.floor(10000 + Math.random() * 90000);
      const payload = [idTrx, data.tgl, data.nama, data.wa, data.amt, data.ket, "Masuk", new Date().toLocaleString()];

      try {
        await fetch(API_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify({ data: payload }) });
        let fw = data.wa.startsWith('0') ? '62' + data.wa.substring(1) : data.wa;
        const link = `${GITHUB_URL}/kuitansi.html?id=${idTrx}`;
        window.open(`https://wa.me/${fw}?text=*KUITANSI MOYA*%0A%0AðŸ“„ ${link}`, '_blank');
        Swal.fire('Berhasil', 'Data masuk & WA terbuka', 'success');
      } catch (e) { Swal.fire('Gagal', 'Cek koneksi', 'error'); }
      finally { btn.disabled = false; btn.innerText = "SIMPAN & KIRIM WA"; }
    }

    async function muatLaporan() {
      const log = document.getElementById('log-data');
      log.innerHTML = "Memuat...";
      const res = await fetch(API_URL);
      const data = await res.json();
      log.innerHTML = data.reverse().map(r => `
        <div style="padding:10px; border-bottom:1px solid #eee; display:flex; justify-content:space-between;">
          <div><b>${r.nama}</b><br><small>${r.id}</small></div>
          <b>Rp ${Number(r.nominal).toLocaleString('id-ID')}</b>
        </div>`).join('');
    }
  </script>
</body>
</html>
